# ns8-imapsync
## Install

Instantiate the module with:

    add-module imapsync

The output of the command will return the instance name.
Output example:

    {"module_id": "imapsync1", "image_name": "imapsync", "image_url": "ghcr.io/nethserver/imapsync:1.0.5"}

## Configure

Let's assume that the imapsync instance is named `imapsync1`.

We need to bind imapsync to a mail server inside the cluster, we use the MODULE_UUID of mail server to configure imapsync, reveal the vmail master secret of local users and start the container waiting for cron tasks or individual user tasks

Launch `configure-module`, by setting the following parameters:
- `mail_server`: module uuid of the mail server
- `mail_host`: local ip of the mail server

Example:

    api-cli run module/imapsync1/configure-module --data '{
        "mail_server":"8dd3b3fe-609c-42f7-a2d1-cecba9461bea",
        "mail_host":"10.5.4.1"
    }'

The above command will start and configure the imapsync instance.

## start to sync a remote imap account to local user account

Example:

```sh
api-cli run module/imapsync1/create-task --data '{
    "localuser": "administrator",
    "remotehostname": "imap.foo.com",
    "remoteport": 143,
    "security": "tls",
    "delete_local": false,
    "delete_remote": false,
    "delete_remote_older": 0,
    "exclude": "folder1,folder2",
    "remoteusername": "username",
    "remotepassword": "password",
    "cron": "5m",
    "task_id": "a0241w",
    "foldersynchronization": "all"
}'
```

Field descriptions:

- **security**: `tls`, `ssl`, or `""` (empty for no security)

- **delete_local**: `true` or `false` â€“ if `true`, deletes mails and
  folders on the local account that are not in the remote account.

- **delete_remote**: `true` or `false` â€“ if `true`, deletes mails on the
  remote account after synchronization to the local account.

- **delete_remote_older**: Number of days after which remote emails are
  deleted. If set to `0`, messages are removed after the transfer.

- **exclude**: Comma-separated list of folders to exclude (e.g.,
  `folder1,folder2,^folder3$`). Use `^` to mark folder names that must
  start with a pattern and `$` for those that must end with one.

- **cron**: Defines task scheduling (e.g., `5m` runs every 5 minutes,
  `"2h"` runs every 2 hours). Internally converted to crontab format
  (`0/5  * * * *` for minutes, `1 */2 * * *` for hours).

- **remote credentials**: Provide the username and password of the remote
  IMAP account. Alternatively, use the IMAP master administrator
  credentials (e.g., `user*vmail` with the corresponding password).

- **foldersynchronization**: Controls which folders are synchronized:
  - `all` â€“ synchronizes all folders.
  - `inbox` â€“ synchronizes only the inbox.
  - `exclusion` â€“ synchronizes all folders except excluded ones.

- **task_id**: Unique identifier for the task, automatically generated by
  the UI.

- **sieve_enabled**: Boolean (`true` or `false`). If `true`, applies the
  user's Sieve filters to synchronized messages. This option is only
  considered when `foldersynchronization` is set to `inbox`.

## delete env and stop a running synchronisation

Example:

    api-cli run module/imapsync1/delete-task --data '{
        "localuser":"administrator"
    }'

## stop a running synchronisation

Example:

    api-cli run module/imapsync1/stop-task --data '{
        "localuser":"administrator"
    }'

## start a running synchronisation

Example:

    api-cli run module/imapsync1/start-task --data '{
        "localuser":"administrator"
    }'

## start all configured tasks
Read all `imapsync/*.env` files and start the synchronization

Example:

    api-cli run module/imapsync1/start-all-tasks

## stop all configured tasks
Read all `imapsync/*.env` files and stop the synchronization

Example:

    api-cli run module/imapsync1/stop-all-tasks

## read configuration

Example:

    api-cli run module/imapsync1/get-configuration

Answer:

```json
{
  "mail_server": "e8a6177c-9ae5-4356-826b-0a5f93b2dbaf",
  "mail_host": "10.5.4.1",
  "mail_server_URL": [
    {
      "name": "mail2",
      "label": "mail2 (R3.rocky9-3.org)",
      "value": "e8a6177c-9ae5-4356-826b-0a5f93b2dbaf,10.5.4.1"
    }
  ],
}
```

## list-tasks

Read configuration from `environment` and from `imapsync/*.{env,pwd}`

api-cli run module/imapsync1/list-tasks

```json
{
  "enabled_mailboxes": [
    {
      "name": "administrator",
      "label": "administrator",
      "value": "administrator"
    },
    {
      "name": "foo",
      "label": "foo",
      "value": "foo"
    },
    {
      "name": "john",
      "label": "john",
      "value": "john"
    }
  ],
  "user_properties": [
    {
      "task_id": "qu1dcb",
      "localuser": "administrator",
      "remoteusername": "user2@domain.com",
      "remotehostname": "imap.domain.com",
      "remoteport": "143",
      "security": "tls",
      "delete_local": false,
      "deletefolder": "",
      "exclude": "",
      "delete_remote": false,
      "delete_remote_older": 0,
      "sieve_enabled": false,
      "expunge_remote": "",
      "cron": "",
      "folder_inbox": "",
      "foldersynchronization": "all",
      "remotepassword": "password",
      "service_running": false
    },
    {
      "task_id": "vd2am3",
      "localuser": "john",
      "remoteusername": "user@domain.com",
      "remotehostname": "imap.domain.com",
      "remoteport": "143",
      "security": "tls",
      "delete_local": false,
      "deletefolder": "",
      "exclude": "",
      "delete_remote": false,
      "delete_remote_older": 0,
      "sieve_enabled": false,
      "expunge_remote": "",
      "cron": "",
      "folder_inbox": "",
      "foldersynchronization": "all",
      "remotepassword": "password",
      "service_running": false
    }
  ]
}

```

## list-informations

You can retrieve the email and folder numbers and the email size for the local and remote account
Example:

    api-cli run module/imapsync9/list-informations --data '{
      "localuser": "john",
      "task_id": "vd2am3"
      }'

output:

```json
{"status": true, "host1Folders": 78, "host2Folders": 78, "host1Messages": 164625, "host2Messages": 155, "host1Sizes": 3060488650, "host2Sizes": 72036894}
```

in case of error you will have

```json
{"status": false}
```
## custom scripts

If necessary, you can add your custom scripts inside the container. To facilitate this, two volumes, included in the backup,
are mounted from their respective directories under the ./state module.

- `cron` (e.g. `~imapsync1/.config/state/cron`)
  This folder is designated for storing cron files, each of which should end its name with `.custom`, while adhering to the cron syntax.

      1 */1 * * *  root /usr/bin/imapsync --host1 SOURCE_SERVER --user1 SOURCE_USERNAME --password1 SOURCE_PASSWORD --host2 DESTINATION_SERVER --user2 DESTINATION_USERNAME --password2 DESTINATION_PASSWORD

  Instead of directly add an imapsync command, you have the option to run a script, which can be stored in the `imapsync` volume.

      1 */1 * * *  root /etc/imapsync/script.custom

- `imapsync` (e.g. `~imapsync1/.config/state/imapsync`)
  In this location, you can store custom scripts (ending with `.custom`) intended for execution by cron. These scripts must be set to be executable by all users.

## troubleshot issues

The `state/imapsync` folder contains the following files:

- **Environment files (`*.env`)** â€“ Stores task-related environment
  variables.
- **Password files (`*.pwd`)** â€“ Contains credentials. The special
  `vmail.pwd` file holds the Dovecot master user's credentials.
- **Lock files (`*.lock`)** â€“ Created when a task is running to prevent
  multiple simultaneous executions.
- **Log files (`*.log`)** â€“ Stores the last Imapsync run log. This file is
  overwritten with each task execution. A summary, including the number of
  transferred messages and the Imapsync exit code, is always sent to the
  system log.

You can filter these files by task name, which is a combination of the
`localuser` and the `task_id`.

Example of files for two tasks, both for local user `foo`. One of them is
running, the other is stopped:


```
.config/state/
â”œâ”€â”€ cron
â”‚Â Â  â”œâ”€â”€ foo_a0241w.cron
â”‚Â Â  â””â”€â”€ foo_a1j44r.cron
â””â”€â”€ imapsync
    â”œâ”€â”€ foo_a0241w.env
    â”œâ”€â”€ foo_a0241w.lock
    â”œâ”€â”€ foo_a0241w.pwd
    â”œâ”€â”€ foo_a0241w.log
    â”œâ”€â”€ foo_a1j44r.env
    â”œâ”€â”€ foo_a1j44r.pwd
    â”œâ”€â”€ foo_a1j44r.log
    â””â”€â”€ vmail.pwd
```

to launch manually a task
```
runagent -m imapsync1
podman exec -ti imapsync /usr/local/bin/syncctl start foo_a1j44r
podman exec -ti imapsync /usr/local/bin/syncctl stop foo_a1j44r
podman exec -ti imapsync /usr/local/bin/syncctl status foo_a1j44r
```

## Bulk import tasks from CSV

Create multiple synchronization tasks at once using a CSV file with the `create_tasks_from_csv.py` script.

### CSV File Format

The CSV file must contain a header row with these 6 required columns (semicolon-delimited):

```
localusername;remoteusername;remotepassword;remotehostname;remoteport;security
pansy.dumbledore5;user1@domain.com;"enquotedPasswordIfSeparatorInside";smtp.domain.com;993;ssl
lavender.umbridge7;user2@domain.com;"enquotedPasswordIfSeparatorInside";smtp.domain.com;993;ssl
dolores.slughorn3;user3@domain.com;"enquotedPasswordIfSeparatorInside";smtp.domain.com;993;ssl
```

**Required columns:**
- `localusername` â€“ Local user account name
- `remoteusername` â€“ Remote IMAP account username
- `remotepassword` â€“ Remote IMAP account password
- `remotehostname` â€“ Remote IMAP server hostname
- `remoteport` â€“ Remote IMAP server port (e.g., 993, 143)
- `security` â€“ Security protocol: `ssl`, `tls`, or empty for no security

Column order does matter.  The script auto-detects the delimiter (`;`, `,`, `|`, or tab).

### Usage

**Validate CSV format before creating tasks:**

```bash
python3 create_tasks_from_csv.py -c imapsync1 users.csv
```

**Create all tasks from CSV:**

```bash
python3 create_tasks_from_csv.py imapsync1 users.csv
```

**Display help:**

```bash
python3 create_tasks_from_csv.py -h
```

### Arguments

- `module_id` â€“ The imapsync module ID (e.g., `imapsync1`, `imapsync2`)
- `csv_file` â€“ Path to the CSV file with user data

### Options

- `-c, --check` â€“ Validate CSV format without creating tasks
- `-h, --help` â€“ Display help message

### Features

- Automatically detects CSV delimiter (`;`, `,`, `|`, tab)
- Validates all 6 required columns are present
- Generates a unique random 6-character task ID (lowercase) for each user
- Auto-fills optional fields with sensible defaults:
  - `cron`: empty (no scheduling)
  - `delete_local`: `false`
  - `delete_remote`: `false`
  - `delete_remote_older`: `0`
  - `exclude`: empty
  - `foldersynchronization`: `all`
  - `sieve_enabled`: `false`
- Calls the API endpoint `module/<module_id>/create-task` for each user
- Displays progress and summary of successful/failed creations

### Example

Create 3 synchronization tasks from a CSV file:

```bash
$ python3 create_tasks_from_csv.py imapsync1 users.csv

Validating CSV file: users.csv

ðŸ“‹ CSV Column Validation:
   Delimiter detected: ';'
   Mode: WITH header row
   Found 6 column(s): localusername, remotehostname, remotepassword, remoteport, remoteusername, security
âœ“ All 6 required columns present
âœ“ Found 3 data row(s)

ðŸ“¦ Starting task creation with module: imapsync1
   Processing 3 user(s)... 

Creating task for pansy.dumbledore5 (ID: a1b2c3)...
âœ“ Success: pansy.dumbledore5

Creating task for lavender.umbridge7 (ID: d4e5f6)...
âœ“ Success: lavender.umbridge7

Creating task for dolores.slughorn3 (ID: g7h8i9)... 
âœ“ Success: dolores.slughorn3

======================================================================
ðŸ“Š Summary: 3 successful, 0 failed
======================================================================
```

## Uninstall

To uninstall the instance:

    remove-module --no-preserve imapsync1

## Testing

Test the module using the `test-module.sh` script:


    ./test-module.sh <NODE_ADDR> ghcr.io/nethserver/imapsync:latest

The tests are made using [Robot Framework](https://robotframework.org/)

## UI translation

Translated with [Weblate](https://hosted.weblate.org/projects/ns8/).

To setup the translation process:

- add [GitHub Weblate app](https://docs.weblate.org/en/latest/admin/continuous.html#github-setup) to your repository
- add your repository to [hosted.weblate.org]((https://hosted.weblate.org) or ask a NethServer developer to add it to ns8 Weblate project
